package cc.zyycc.launcher;

import java.io.*;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.util.Properties;

public class ServerInitializer {
    public static void prepareServerDirectory(File serverDir) throws IOException {
        if (!serverDir.exists()) {
            serverDir.mkdirs();
        }
        File eula = new File(serverDir, "eula.txt");
        if (!checkEulaAccepted(eula)) {
            confirmEulaAndSave(eula);
        }
        File serverProperties = new File(serverDir, "server.properties");
        if (!serverProperties.exists()) {
            generateServerProperties(serverProperties);
        }
    }

    private static void generateServerProperties(File targetFile) throws IOException {
        if (targetFile.exists()) return;
        try (InputStream in = ServerInitializer.class.getClassLoader().getResourceAsStream("default-server.properties")) {
            if (in == null) throw new FileNotFoundException("default-server.properties not found in resources!");
            Properties props = new Properties();
            props.load(new InputStreamReader(in, StandardCharsets.UTF_8));

            try (Writer out = new OutputStreamWriter(Files.newOutputStream(targetFile.toPath()), StandardCharsets.UTF_8)) {
                props.store(out, "Generated by ZyyLauncher");
                System.out.println("âœ… å·²ç”Ÿæˆ server.propertiesï¼š" + targetFile.getAbsolutePath());
            }
        }
    }

    private static void confirmEulaAndSave(File eula) throws IOException {

        System.out.println("âš ï¸ ä½ å¿…é¡»åŒæ„ Minecraft çš„æœ€ç»ˆç”¨æˆ·è®¸å¯åè®® (EULA) æ‰èƒ½å¯åŠ¨æœåŠ¡å™¨ã€‚");
        System.out.println("ğŸ“„ è¯·è®¿é—®å¹¶é˜…è¯»: https://aka.ms/MinecraftEULA");
        System.out.print("âœ… æ˜¯å¦åŒæ„ EULAï¼Ÿè¾“å…¥ 'yes' åŒæ„: ");


        BufferedReader reader = new BufferedReader(new InputStreamReader(System.in));
        String input = reader.readLine();
        if ("yes".equalsIgnoreCase(input.trim())) {
            try (PrintWriter out = new PrintWriter(new FileWriter(eula))) {
                out.println("# By changing the setting below to TRUE you are indicating your agreement to our EULA.");
                out.println("# https://aka.ms/MinecraftEULA");
                out.println("eula=true");
            }
            System.out.println("âœ… EULA åŒæ„è®°å½•å·²ä¿å­˜ï¼Œç»§ç»­å¯åŠ¨æœåŠ¡ç«¯...");
        } else {
            System.err.println("âŒ ä½ æ²¡æœ‰åŒæ„ EULAï¼ŒæœåŠ¡ç«¯å°†ä¸ä¼šå¯åŠ¨ã€‚");
            System.exit(0);
        }
    }

    private static boolean checkEulaAccepted(File eulaFile) {
        if (!eulaFile.exists()) return false;

        Properties props = new Properties();
        try (FileReader reader = new FileReader(eulaFile)) {
            props.load(reader);
        } catch (IOException e) {
            return false;
        }

        return "true".equalsIgnoreCase(props.getProperty("eula"));
    }
}
